# Synopsis

The FOCUS uses 3D curves to represent coils in fusion devices.
For a given plamsa configuration (with or without target Bn distributions), FOCUS could find optimal coils, meeting the user-specified physics and engineering constraints.

&nbsp;

# Before running

## Get the source
If you are fresh to GitHub, you can visit this [page](https://princetonuniversity.github.io/FOCUS/Get_the_code) to learn how to get a copy of the code.

## Compile and make options
* Prerequisites

  The current version of the FOCUS is using intel compiler with libraries like NAG, OPENMPI, hdf5-serial and OCULUS.
  If you are at PPPL cluster, you should add these terms in your environment variables file (like *~/.cshrc*):
  ```
  module load intel nag/mark22 openmpi/1.8.4 hdf5-serial/1.8.5
  setenv OCULUS  /u/shudson/Oculus
  ```
  *The OCULUS library is mainly for post-proceedings. If you cannot access OCULUS, try to comment out the related parts.*

* Makefile

  Go to the *./Old/* file.
  
  All the Fortran90 sources are in \*.h files. When **make**, \*.h file will produce \*.F90 with extracted macros (*seen in [macros](https://github.com/PrincetonUniversity/FOCUS/tree/master/Old/macros)*).

  There are two options vailable in [Makefile](https://github.com/PrincetonUniversity/FOCUS/tree/master/Old/Makefile):
  
  **Optimized concise version (recommended)**
  ```
  make xfocus
  ```
  **Debugging version (with more stricted checkings and more error informations)**
  ```
  make dfocus
  ```
  
## Prepare input files

FOCUS needs three input files for running, input namelist, target plasma boundary and initial coils.
Here is a brief description for these three files. 
For instance, you want to run the code with a case name of "example".

* input namelist
  
  The file **example.fo** contains all the input variables for FOCUS. 
  A detailed description for these variables can be found in [globals.pdf](https://princetonuniversity.github.io/FOCUS/globals.pdf).
  These files should be placed in the same directory as the executable (use a link).
  
* target plasma boundary

  There are two optional files can be read for providing a target plasma boundary.
  It's controled by *Itopology* in the input namelist. 
  
  - *Itopology = 0* : **plasma.boundary**
  
    This is for general unknotted cases, like stellarator and tokamaks. It takes VMEC-like format. 
    Detalis can be seen in [surface.pdf](https://princetonuniversity.github.io/FOCUS/surface.pdf)
    
  - *Itopology = 1* : **example.fo.knot**
  
     This option reads an axis and the plasma surface is generated by swipping a circule (or rotating ellipse) along the axis.
     Details can been seen in [rdknot.pdf](https://princetonuniversity.github.io/FOCUS/rdknot.pdf)
     
* initial coils

  FOCUS also requires the user to provide an initial guess for the coils. This is controled by *Linitialize*.
  
  - *Linitialize = -N* (N>1)
  
    Initialize N circular coils (r=rmin) for *Itopology=1* only.
    
  - *Linitialize = -1* : **coils.example**
  
    Read the coils data from **coils.example** and fit the coils with Fourier coefficients. 
    The format ofcoils.\* file can be seen in [VMECwiki](http://vmecwiki.pppl.wikispaces.net/MAKEGRID).
    
  - *Linitialize =  0* : **example.focus**
  
    Read the coils data from **example.focus**. This file contains all the Fourier harmonics and control labels for the coils.
    
  - *Linitialize =  N* (Nâ‰¥1)
  
    Initialize N circular coils (r=rmin) surrounding the plasma boundary for *Itopology=0* only.

&nbsp;

# Running

Once you finish preparing the input files and successfully compile the code, move to your working directory, which contains the input files and the executable, and then type
```
mpirun -np 32 xfocus example
```
You may need to allocate computating cores first, e.g. try `salloc -p dawson -n 32 -t 24:00:00` at PPPL.

The code shoul print some information on the screen (or in stdout file for *sbatch*).

&nbsp;

# Output files

The main output data is written in hdf5 file **example.fo.h5**. You can use Matlab or python or any other tools to load the data.

Besides the hdf5, FOCUS will also write the **coils.example** and **example.focus** files. (If you want to retain the input coils, remember to make a copy first)

And also, there are intermediate savings for the coils to plot a movie. They are ordered in numbers starting from  **.example.fo.filaments.001**. 

&nbsp;

# Plotting tools
There are several tools for processing the data, like a [python package](https://github.com/PrincetonUniversity/FOCUS/blob/master/pyfocus/coil.py), a powerful GUI interface Echidna in IDL written by Dr. Hudson, and some MATLAB scripts by Dr. Lazerson.

*I will uplaod some of them later.*

&nbsp;

# Documentations
In the source files, the comments starting with "!latex " can be exported into a tex file and generate pdf documentations.
You can find some of them in [Subroutins](https://princetonuniversity.github.io/FOCUS/subroutines).

&nbsp;

# Contact
If you have any questions, please contact Caoxiang Zhu (czhu@pppl.gov or zcxiang@mail.ustc.edu.cn).

Please note that there are no warranties! :octocat:

-----------
